<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>棚卸計算機 - Botanical Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@900&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-1: #A9C0A6; /* セージ */
            --color-2: #F5EDE3; /* クリーム */
            --color-3: #707862; /* オリーブ */
            --color-4: #DDD5CC; /* グレージュ */
            --color-5: #C5D3C4; /* 薄セージ */
            --text-main: #303030;
            --white: #ffffff;
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent;
            font-family: 'Zen Maru Gothic', sans-serif;
            font-weight: 900;
            color: var(--text-main);
        }

        body {
            background-color: var(--color-2);
            margin: 0;
            height: 100vh;
            height: 100dvh; 
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding-bottom: env(safe-area-inset-bottom);
        }

        /* ヘッダー */
        .header {
            background: var(--color-3);
            padding: 8px 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            z-index: 100;
        }

        .header-title {
            color: var(--color-2);
            font-size: 0.9rem;
            white-space: nowrap;
        }

        .header-btns {
            display: flex;
            gap: 4px;
        }

        .header-btns button {
            background: var(--color-2);
            color: var(--color-3);
            border: none;
            padding: 8px 10px;
            border-radius: 6px;
            font-size: 0.75rem;
            box-shadow: 0 2px 0 rgba(0,0,0,0.1);
        }

        /* 履歴表示エリア */
        #history-container {
            flex: 1;
            overflow-y: auto;
            background: var(--color-2);
            transition: all 0.3s ease; /* アニメーション */
        }

        .history-item {
            display: flex;
            align-items: center;
            padding: 12px 10px;
            border-bottom: 2px solid var(--color-4);
            gap: 8px;
            background: rgba(255,255,255,0.4);
        }

        .line-num { width: 25px; color: var(--color-1); font-size: 0.8rem; text-align: center; }

        .formula {
            flex: 1;
            font-size: 1.5rem;
            background: var(--white);
            border: 2px solid var(--color-1);
            padding: 8px 12px;
            border-radius: 10px;
            min-width: 0;
            outline: none;
        }

        .line-results {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            min-width: 100px;
        }

        .line-subtotal { font-size: 0.8rem; color: var(--color-3); opacity: 0.8; }
        .total-val { font-size: 1.2rem; color: var(--color-3); }
        .unit { font-size: 0.6rem; margin-left: 2px; }

        .btn-del-row {
            color: var(--color-1);
            background: none;
            border: none;
            padding: 5px;
            font-size: 1.5rem;
        }

        /* 入力エリア全体のラッパー（表示・非表示の切り替え対象） */
        #input-section {
            transition: transform 0.3s ease, height 0.3s ease;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
        }

        /* 非表示状態のスタイル */
        .input-hidden {
            transform: translateY(100%);
            height: 0 !important;
            overflow: hidden;
        }

        /* 入力中表示エリア */
        #display-container {
            background: var(--color-4);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top: 2px solid var(--color-1);
        }
        #display { font-size: 2.2rem; }
        .display-label { font-size: 0.8rem; opacity: 0.7; }

        /* キーパッド */
        .keypad {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 4px;
            background: var(--color-1);
            padding: 4px;
        }

        button.key {
            border: none;
            padding: 18px 0;
            font-size: 1.8rem;
            background: var(--white);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 0 rgba(0,0,0,0.1);
        }

        button.key:active { 
            background: var(--color-4); 
            transform: translateY(2px);
            box-shadow: none;
        }

        .btn-op { background: var(--color-5); }
        .btn-clr, .btn-ent { background: var(--color-3) !important; color: var(--color-2) !important; }
        .btn-ent { grid-column: span 2; font-size: 1.6rem; }
        .btn-util { background: var(--color-5); }
        .btn-plus-tall { grid-row: span 2; background: var(--color-1) !important; color: var(--white) !important; font-size: 2.5rem; }

        /* モード切替ボタンの強調色 */
        .mode-active {
            background: var(--color-1) !important;
            color: var(--white) !important;
        }

    </style>
</head>
<body>

    <div class="header">
        <div class="header-title">棚卸計算機</div>
        <div class="header-btns">
            <button onclick="exportCSV()">保存</button>
            <button onclick="resetAll()">消去</button>
            <button id="toggle-btn" onclick="toggleKeypad()" class="">履歴表示</button>
        </div>
    </div>
    
    <div id="history-container"></div>

    <div id="input-section">
        <div id="display-container">
            <span class="display-label">入力中</span>
            <div id="display">0</div>
        </div>

        <div class="keypad">
            <button class="key" onclick="append('7')">7</button>
            <button class="key" onclick="append('8')">8</button>
            <button class="key" onclick="append('9')">9</button>
            <button class="key btn-op" onclick="append('÷')">÷</button>

            <button class="key" onclick="append('4')">4</button>
            <button class="key" onclick="append('5')">5</button>
            <button class="key" onclick="append('6')">6</button>
            <button class="key btn-op" onclick="append('×')">×</button>

            <button class="key" onclick="append('1')">1</button>
            <button class="key" onclick="append('2')">2</button>
            <button class="key" onclick="append('3')">3</button>
            <button class="key btn-op" onclick="append('-')">-</button>

            <button class="key" onclick="append('0')">0</button>
            <button class="key" onclick="append('00')">00</button>
            <button class="key btn-clr" onclick="clearDisplay()">C</button>
            <button class="key btn-plus-tall" onclick="append('+')">+</button>

            <button class="key btn-ent" onclick="commit()">ENTER</button>
            <button class="key btn-util" onclick="backspace()">⌫</button>
        </div>
    </div>

    <script>
        let history = []; 
        let currentInput = "";
        let isHistoryMode = false;

        const displayEl = document.getElementById('display');
        const historyContainer = document.getElementById('history-container');
        const inputSection = document.getElementById('input-section');
        const toggleBtn = document.getElementById('toggle-btn');

        window.onload = () => {
            const saved = localStorage.getItem('inventory_botanical_v2');
            if (saved) {
                history = JSON.parse(saved);
                recalculate();
            }
        };

        // キーパッドの表示・非表示切り替え
        function toggleKeypad() {
            isHistoryMode = !isHistoryMode;
            if (isHistoryMode) {
                inputSection.classList.add('input-hidden');
                toggleBtn.innerText = "入力に戻る";
                toggleBtn.classList.add('mode-active');
            } else {
                inputSection.classList.remove('input-hidden');
                toggleBtn.innerText = "履歴表示";
                toggleBtn.classList.remove('mode-active');
                // 入力に戻った時は一番下へスクロール
                scrollToBottom();
            }
        }

        function saveData() {
            localStorage.setItem('inventory_botanical_v2', JSON.stringify(history));
        }

        function updateDisplay() {
            displayEl.innerText = currentInput || "0";
        }

        function append(char) {
            if (currentInput === "0" && (char === "0" || char === "00")) return;
            currentInput += char;
            updateDisplay();
        }

        function clearDisplay() {
            currentInput = "";
            updateDisplay();
        }

        function backspace() {
            currentInput = currentInput.slice(0, -1);
            updateDisplay();
        }

        function resetAll() {
            if(confirm("全てのデータを消去しますか？")) {
                history = [];
                currentInput = "";
                saveData();
                renderHistory();
                updateDisplay();
            }
        }

        function deleteRow(index) {
            history.splice(index, 1);
            recalculate();
        }

        function commit() {
            if (!currentInput) return;
            history.push({ formula: currentInput });
            currentInput = "";
            recalculate();
            updateDisplay();
            scrollToBottom();
        }

        function scrollToBottom() {
            setTimeout(() => { 
                historyContainer.scrollTo({ top: historyContainer.scrollHeight, behavior: 'smooth' });
            }, 100);
        }

        function recalculate() {
            let runningTotal = 0;
            history = history.map((item, index) => {
                let formulaStr = item.formula.replace(/×/g, '*').replace(/÷/g, '/');
                let lineVal = 0;
                try {
                    if (index === 0) {
                        let cleanFormula = formulaStr;
                        if (['+','-','*','/'].includes(formulaStr[0])) cleanFormula = "0" + formulaStr;
                        lineVal = eval(cleanFormula) || 0;
                        runningTotal = lineVal;
                    } else {
                        if (!['+','-','*','/'].includes(formulaStr[0])) {
                            lineVal = eval(formulaStr) || 0;
                            runningTotal += lineVal;
                        } else {
                            runningTotal = eval(`${runningTotal} ${formulaStr}`);
                            lineVal = eval(formulaStr.substring(1)) * (formulaStr[0] === '-' ? -1 : 1);
                        }
                    }
                } catch (e) { console.error(e); }
                return { formula: item.formula, lineResult: lineVal, total: Math.round(runningTotal) };
            });
            saveData();
            renderHistory();
        }

        function renderHistory() {
            historyContainer.innerHTML = "";
            history.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `
                    <div class="line-num">${index + 1}</div>
                    <div class="formula" contenteditable="true" inputmode="numeric" onblur="editFormula(${index}, this.innerText)">${item.formula}</div>
                    <div class="line-results">
                        <div class="line-subtotal">${item.lineResult > 0 ? '+':''}${Math.round(item.lineResult).toLocaleString()}<span class="unit">行計</span></div>
                        <div class="total-val">${item.total.toLocaleString()}<span class="unit">累計</span></div>
                    </div>
                    <button class="btn-del-row" onclick="deleteRow(${index})">×</button>
                `;
                historyContainer.appendChild(div);
            });
        }

        function editFormula(index, newFormula) {
            const cleanFormula = newFormula.replace(/\s/g, '').replace(/\n/g, '');
            if (cleanFormula === "") {
                deleteRow(index);
            } else {
                history[index].formula = cleanFormula;
                recalculate();
            }
        }

        function exportCSV() {
            if (history.length === 0) return;
            let csvContent = "\uFEFFNo,数式,行計,累計\n";
            history.forEach((item, index) => {
                csvContent += `${index + 1},${item.formula},${item.lineResult},${item.total}\n`;
            });
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `棚卸表_${new Date().toLocaleDateString()}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        updateDisplay();
    </script>
</body>
</html>
